---
description: Mastraエージェント／ワークフロー／ツールに関するルール（src/mastra/**/*.ts）
globs: src/mastra/**/*.ts
alwaysApply: false
---

# Mastra Agents & Tools Rules

このルールは、`src/mastra/**/*.ts` に対して適用される、Mastraエージェント／ワークフロー／ツール実装用のガイドラインです。

## エージェント定義

- エージェントは `@mastra/core` の最新ドキュメントに従って定義してください。
  - `Agent` コンストラクタの引数・オプションは、インストールされている `@mastra/core` のバージョンに必ず整合させます。
- モデル指定は、インストールされているモデルラッパーやMastraドキュメントに従った形式を用い、推測で書き換えないでください。
- `instructions` には、そのエージェントの役割・対象ユーザー・口調・利用できるツールの範囲を明示します。

### shoppingAgent に関する注意

- `src/mastra/agents/shopping.ts` の `shoppingAgent` は、以下の特徴を持つ日本語アシスタントです。
  - カジュアルで親しみやすい日本語。
  - 絵文字（🛒📝✅ など）を適度に使用。
  - 買い物リストの管理（追加・表示・完了・クリア）と、店舗関連ツールの呼び出しが主な役割。
- 上記のキャラクターや役割を大きく変える場合は、`instructions` 内で意図を明示し、関連ドキュメントも更新することを検討してください。

## ツール設計

- ツールは `src/mastra/tools` 配下に配置し、再利用しやすい形で実装します。
- 引数と戻り値には、可能な限りZodなどのスキーマバリデーションを用いて、エージェントからの呼び出し時に型安全性を確保します。
- DBアクセスや外部APIコールを行うツールでは、以下を徹底してください。
  - 環境変数名（例: DB URL, APIキー）をコード中に直書きせず、設定ファイルや`.env`経由で参照する。
  - 失敗時のエラーハンドリングを行い、エージェントがユーザーにわかりやすいメッセージを返せるようにする。

## ワークフロー

- 複数ステップからなる処理は、ワークフローとして `src/mastra/workflows` に切り出すことを検討してください。
- ワークフロー内では、ツール呼び出しやエージェント呼び出しの制御フローを明確にし、副作用のある処理（DB更新・外部API呼び出しなど）を見つけやすくします。

## ロギング・テスト

- 重要な分岐や外部サービス呼び出しには、適切なロギング（例: `@mastra/loggers`）を検討してください。
- エージェントやツールの動作確認には、用意されているスクリプト（例: `npm run test:mastra` や `src/scripts/test-mastra.ts`）を活用します。

