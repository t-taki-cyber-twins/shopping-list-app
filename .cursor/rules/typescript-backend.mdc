---
description: Next.js APIルートとDBレイヤ向けのTypeScript実装ルール
globs: |
  src/app/**/*.ts
  src/app/**/*.tsx
  src/lib/**/*.ts
alwaysApply: false
---

# TypeScript Backend (API & DB) Rules

このルールは、`src/app/api/**` などのNext.js APIルートおよび `src/lib/**/*.ts`（特に `src/lib/db.ts`）に対して適用されるバックエンド実装ガイドラインです。

## APIルート設計

- APIルートは `src/app/api/**/route.ts` に配置し、Next.jsの規約に従ったハンドラ（`GET`, `POST` など）をエクスポートします。
- レスポンス形式は、以下の点を意識して統一してください。
  - 成功時: `200`系ステータスと共に、JSONでわかりやすいフィールド名を返す。
  - 失敗時: エラー理由を示すメッセージと適切なステータスコードを返す。
- 入力値（リクエストボディ・クエリパラメータ）は、可能な限りZodなどでバリデーションし、不正値に対しては早期にエラーを返します。

## DBアクセスレイヤ（src/lib/db.ts）

- DBへの直接アクセスロジックは `src/lib/db.ts`（または同レイヤのモジュール）に集約し、APIルート内に生のクエリを書くことは避けてください。
- 既存の接続・クエリユーティリティがある場合は、それを再利用し、独自の接続管理を増やさないようにします。
- トランザクションやリトライが必要な処理では、既存のパターンやユーティリティが無いかをまず確認してください。

## エラーハンドリングと安全性

- 想定外の例外はキャッチし、最低限ログに残すか、エラーレスポンスとしてクライアントに通知してください。
- 初期化用のエンドポイント（例: `/api/init-db`）は、本番環境で誤って実行されないようにガード条件や環境変数チェックを導入することを推奨します。
- 破壊的な操作（テーブル削除・全データ削除など）は、明示的なフラグや限定的な環境でのみ実行されるようにしてください。

## 型と依存関係

- TypeScriptの型定義（リクエスト・レスポンス・DBスキーマに対応する型）は、可能な限り共有し、重複定義を避けます。
- `package.json` の依存関係（`next`, `pg`, `@vercel/postgres`, `@mastra/pg` など）を前提としてコードを書き、サードパーティライブラリを追加する場合は、その影響範囲を意識してください。

